<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
					   xmlns:s="library://ns.adobe.com/flex/spark"
					   xmlns:mx="library://ns.adobe.com/flex/mx"
					   xmlns:ui="com.complib.common.ui.*"
					   minWidth="800" minHeight="600" closing="onClosing(event)"
					   creationComplete="initApp();">
	
	<s:states>
		<!-- Define the new view states. -->
		<s:State name="Start"/>
		<s:State name="Test"/>
		<s:State name="End"/>
	</s:states>
	
	<fx:Declarations>
		<!-- Placer ici les éléments non visuels (services et objets de valeur, par exemple). -->
		<s:Sequence id="fadeSignalAcknowledgement" duration="1000" target="{signal_ak}">
			<s:Fade id="fadeShow" alphaFrom="0.0" alphaTo="1.0"/>
			<s:Fade id="fadeHide" alphaFrom="1.0" alphaTo="0.0"/>
		</s:Sequence>
	</fx:Declarations>
	
	
	<fx:Script>
		<![CDATA[
			
			// To get as3xls to work, make sure it is in the /libs folder.
			// In Flash Builder, go to menu Windows > Preferences > General > Workspace > Linked Resources
			// and add the .swc file to the linked resources.
			// the import "import com.as3xls.xls.*;" tend to disappear when you add a new one
			
			/*---- Imports ----*/
			import com.as3xls.xls.ExcelFile;
			import com.as3xls.xls.Sheet;
			
			import flash.events.Event;
			import flash.events.KeyboardEvent;
			import flash.events.TimerEvent;
			import flash.utils.Timer;
			
			import mx.controls.Button;
			import mx.formatters.DateFormatter;
			
			/*---- Constants ----*/
			private const SECOND:Number = 1000;
			private const MINUTE:Number = 60 * SECOND;
			private const TIMER_INTERVAL:Number = 15 * SECOND;
			private const TIMER_FIRST_SIGNAL:Number = 15 * SECOND;
			private const MIN_RANDOM_INTERVAL:Number = 4;
			private const MAX_RANDOM_INTERVAL:Number = 15;
			
			/*---- Attributes ----*/
			protected var xls:ExcelFile;
			protected var sheet:Sheet;
			private var xmlResult:String;
			private var excelStroopRow:int;
			private var excelSignalsRow:int;
			
			private var nbErrorsStroop:int;
			
			private var baseSignalTimer:int;
			private var allSignalsTimer:Timer;
			private var oneSignalTimer:Timer;
			
			private var nativeProcessStartupInfo:NativeProcessStartupInfo = new NativeProcessStartupInfo();
			private var process:NativeProcess = new NativeProcess();
			
			
			/*---- Methods ----*/
			private function onClosing(event:Event):void{
				this.writeXML();
				this.writeExcel();
			}
			
			private function initApp():void {
				//this.runExeFile("C:\\Windows\\System32\\notepad.exe");
				this.xmlResult = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>"+"\n";
				this.initExcel();
				this.initSignalsTimer();
				this.addEventListener(KeyboardEvent.KEY_UP, keyHandler);
			}
			
			private function startTest():void {
				this.currentState='Test';
				this.focusManager.setFocus(color_test);
				this.startSignalsTimer();
			}
			
			// Stroop methods
			private function keyHandler(event:KeyboardEvent):void {
				var CurrentDateTime:Date = new Date();
				var CurrentDF:DateFormatter = new DateFormatter();
				CurrentDF.formatString = "YYYY/MM/DD HH:NN:SS.QQQ"
				var time:String = CurrentDF.format(CurrentDateTime);
				xmlResult += "<signal_detected>"+time+"</signal_detected>"+"\n";
				fadeSignalAcknowledgement.end();
				fadeSignalAcknowledgement.play();
				
				trace(oneSignalTimer.running);
				
				if(oneSignalTimer.running) {
					stopOneSignal(null);
				}
			}
			
			private function generateNumber1to4():Number{
				var low:Number = 1;
				var high:Number= 4;
				var result:Number = Math.floor(Math.random() * (1 + high - low)) + low;
				return result;
			}
			
			private function generateQuestionColor():String{
				var num:Number = generateNumber1to4();
				switch(num){
					case 1:
						// Red
						return "#FF0000";
					case 2:
						// Blue
						return "#0000FF";
					case 3:
						// Green
						return "#169C16";
					case 4:
						// Yellow
						return "#F7FE2E";
					default:
						// White
						return "#FFFFFF";
				}
			}
			
			private function generateQuestionText():String{
				nbErrorsStroop = 0;
				var num:Number = generateNumber1to4();
				switch(num){
					case 1:
						// Red
						return "Red";
					case 2:
						// Blue
						return "Blue";
					case 3:
						// Green
						return "Green";
					case 4:
						// Yellow
						return "Yellow";
					default:
						// White
						return "White";
				}
			}
			
			private function buttonToColorUint(event:Event):String{
				switch(event.target.id){
					case "Red":
						return "16711680";
					case "Blue":
						return "255";
					case "Green":
						return "1481750";
					case "Yellow":
						return "16252462";
					default:
						return "#FFFFFF";
				}
				
			}
			
			
			/**
			 * This method is used to call a .exe application
			 * to communicate with our prototype.
			 * @path : path of the .exe to execute
			 */
			private function runExeFile(path:String):void{
				if(NativeProcess.isSupported){
					var file:File = File.applicationDirectory;
					file = file.resolvePath(path);
					nativeProcessStartupInfo.executable = file;
					process.start(nativeProcessStartupInfo);
				}
				else{
				}
			}
			
			// XML methods
			private function writeXML():void{
				var CurrentDateTime:Date = new Date();
				var CurrentDF:DateFormatter = new DateFormatter();
				CurrentDF.formatString = "YYYY/MM/DD HH:NN:SS.QQQ"
				var time:String = CurrentDF.format(CurrentDateTime);
				
				var myPattern:RegExp = /\//g;  
				time = time.replace(myPattern, "-");
				myPattern = /\./g;
				time = time.replace(myPattern, "-");
				myPattern = /:/g;
				time = time.replace(myPattern, "_");
				
				var fName:String="./StroopResults"+time+"/xml/stroop_results.xml";//define the name of the folder
				var file:File = File.desktopDirectory.resolvePath(fName);//with "File.desktopDirectory" point the file to the user desktop
				var stream:FileStream = new FileStream();// Opena new fileStream
				
				stream.open(file, FileMode.WRITE);//put the filemode on "write"
				
				stream.writeUTFBytes(xmlResult);//assign the string that we have to write
				stream.close();//close the fileStream
			}
			
			/**
			 * This function handles an answer to the stroop test.
			 * It registers the results.
			 * @event : Event to register
			 */
			private function printMessage(event:Event):void  {
				var CurrentDateTime:Date = new Date();
				var CurrentDF:DateFormatter = new DateFormatter();
				CurrentDF.formatString = "YYYY/MM/DD HH:NN:SS.QQQ"
				var time:String = CurrentDF.format(CurrentDateTime);
				
				if(buttonToColorUint(event)==color_test.getStyle('color')){
					message.text = "Correct answer";
					xmlResult += "<correct_answer>"+time+"</correct_answer>"+"\n";
					
					// Excel results
					sheet.setCell(excelStroopRow, 5, time);
					sheet.setCell(excelStroopRow, 6, nbErrorsStroop);
					excelStroopRow++;
					
					// Next question
					sheet.setCell(excelStroopRow, 4, time);
					color_test.setStyle('color',generateQuestionColor());
					color_test.text=generateQuestionText();
				}
				else{
					message.text = "Wrong answer";
					xmlResult += "<wrong_answer>"+time+"</wrong_answer>"+"\n";
					
					// Excel results
					nbErrorsStroop++;
				}
			}
			
			/**
			 * This method initialize the Excel file for registering data.
			 */
			private function initExcel():void {
				xls = new ExcelFile();
				sheet = new Sheet();
				sheet.resize(160, 12);
				
				sheet.setCell(0, 0, "Today's date:");
				var CurrentDateTime:Date = new Date();
				var CurrentDF:DateFormatter = new DateFormatter();
				CurrentDF.formatString = "YYYY/MM/DD HH:NN:SS.QQQ"
				var time:String = CurrentDF.format(CurrentDateTime);
				sheet.setCell(0, 2, time);
				
				sheet.setCell(1, 0, "Signal sent date");
				sheet.setCell(1, 1, "Signal acknowledged date");
				sheet.setCell(1, 2, "Signal id");
				
				sheet.setCell(1, 4, "Stroop test date");
				sheet.setCell(1, 5, "Stroop correct answer date");
				sheet.setCell(1, 6, "Stroop errors");
				
				excelSignalsRow = 2;
				excelStroopRow = 2;
			}
			
			/**
			 * This method writes the Excel file.
			 * Called in the end of the execution.
			 */
			private function writeExcel():void {
				xls.sheets.addItem(sheet);
				var bytes:ByteArray = xls.saveToByteArray();
				
				var stream:FileStream = new FileStream();
				var file:File = File.desktopDirectory.resolvePath("data.xls");
				stream.open(file, FileMode.WRITE);
				stream.writeBytes(bytes);
				stream.close();
			}
			
			
			// Timer Methods
			private function initSignalsTimer(): void {
				allSignalsTimer = new Timer(TIMER_FIRST_SIGNAL, 1);
				oneSignalTimer = new Timer(5 * SECOND, 1);
				
				allSignalsTimer.addEventListener(TimerEvent.TIMER, sendSignal);
				oneSignalTimer.addEventListener(TimerEvent.TIMER, stopOneSignal);
			}
			
			private function startSignalsTimer():void {
				allSignalsTimer.start();
			}
			
			private function sendSignal(evt:TimerEvent):void {
				// Calls our prototype with randomized parameters
				/// set the parameters
				var couleur:int = Math.floor(Math.random() *
					(2 - 1 + 1)) + 1;
				var forme:int = Math.floor(Math.random() *
					(3 + 1));
				var movement:int = Math.floor(Math.random() *
					(2 + 1));
				
				/// register the parameters in the Excel file
				sheet.setCell(excelSignalsRow, 2, 100*couleur + 10*forme + movement);
				
				/// call the .exe and register the starting time
				
				// Signal date excel
				var CurrentDateTime:Date = new Date();
				var CurrentDF:DateFormatter = new DateFormatter();
				CurrentDF.formatString = "YYYY/MM/DD HH:NN:SS.QQQ"
				var time:String = CurrentDF.format(CurrentDateTime);
				sheet.setCell(excelSignalsRow, 0, time);
				
				// Add to XML
				xmlResult += "<signal_send>"+time+"</signal_send>"+"\n";
				
				// Count until 5 second before stopping the signal,
				// If it has not been acknowledged as expected
				//oneSignalTimer = new Timer(5 * SECOND, 1);
				//oneSignalTimer.addEventListener(TimerEvent.TIMER, stopOneSignal);
				oneSignalTimer.start();
			}
			
			private function stopSignalsTimer():void {
				allSignalsTimer.stop();
				allSignalsTimer.reset();
			}
			
			private function stopOneSignal(evt:TimerEvent):void {
				var CurrentDateTime:Date = new Date();
				
				var CurrentDF:DateFormatter = new DateFormatter();
				CurrentDF.formatString = "YYYY/MM/DD HH:NN:SS.QQQ"
				var time:String = CurrentDF.format(CurrentDateTime);
				
				var random:int;
					
				// Add to XML
				xmlResult += "<signal_stop>"+time+"</signal_stop>"+"\n";
				
				oneSignalTimer.stop();
				oneSignalTimer.reset();
				
				// The end is registered either the signal has been seen or not
				sheet.setCell(excelSignalsRow++, 1, time);
				
				random = Math.floor(Math.random() * (MAX_RANDOM_INTERVAL - MIN_RANDOM_INTERVAL + 1)) + MIN_RANDOM_INTERVAL;
				allSignalsTimer new Timer(random * SECOND, 1);
				allSignalsTimer.addEventListener(TimerEvent.TIMER, sendSignal);
				allSignalsTimer.start();
			}

		]]>
	</fx:Script>
	
	<mx:Panel width="100%" height="100%" horizontalAlign="center" layout="horizontal"
			  paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="100"
			  title="Stroop Task" verticalAlign="middle">
		
		<mx:VBox>
			<mx:TextArea id="signal_ak" visible="true" width="100%" height="200%" alpha="0.0"
						 borderVisible="false" fontSize="28" textAlign="center" 
						 text="Signal acknowledgement received" includeIn="Test"/>
			
			<mx:TextArea id="color_test" width="100%" height="100%" borderVisible="false"
						 color="#F7FE2E" contentBackgroundColor="#D8D8D8" editable="false"
						 fontSize="32" text="Blue" textAlign="center" includeIn="Test"/>
			
			<mx:HBox>
				<mx:Button id="startButton" label="Start the test" focusEnabled="false" click="startTest();" includeIn="Start"/>
				
				<mx:Button id="Green" label="Green" focusEnabled="false" click="printMessage(event)" includeIn="Test"/>
				
				<mx:Button id="Blue" label="Blue" focusEnabled="false" click="printMessage(event)" includeIn="Test"/>
				
				<mx:Button id="Yellow" label="Yellow" focusEnabled="false" click="printMessage(event)" includeIn="Test"/>
				
				<mx:Button id="Red" label="Red" focusEnabled="false" click="printMessage(event)" includeIn="Test"/>
			</mx:HBox>
			
			<mx:TextArea id="message" width="100%" height="100%" color="#0000FF" 
						 editable="false" text="" includeIn="Test"/>
			
		</mx:VBox>
		
	</mx:Panel>
	
</s:WindowedApplication>

